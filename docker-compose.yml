version: '3.8'

services:
  # ─────────────────────────────────────────────────────────────
  # SPLUNK ENTERPRISE
  # ─────────────────────────────────────────────────────────────
  splunk:
    image: splunk/splunk:latest
    hostname: splunk
    container_name: splunk-demo-splunk
    environment:
      SPLUNK_START_ARGS: --accept-license
      SPLUNK_GENERAL_TERMS: --accept-sgt-current-at-splunk-com
      SPLUNK_PASSWORD: ${SPLUNK_PASSWORD:-DemoPass123!}
      SPLUNK_LICENSE_URI: Free
      SPLUNK_HEC_TOKEN: ${SPLUNK_HEC_TOKEN:-demo-hec-token-12345}
    ports:
      - "8000:8000"   # Web UI
    volumes:
      - splunk-var:/opt/splunk/var
      - splunk-etc:/opt/splunk/etc
      - ./splunk/apps/demo_app:/opt/splunk/etc/apps/demo_app
    healthcheck:
      test: ['CMD', 'curl', '-sf', 'http://localhost:8000/en-US/account/login']
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 180s
    networks:
      - demo-network
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ─────────────────────────────────────────────────────────────
  # LOG GENERATOR (Real-time)
  # ─────────────────────────────────────────────────────────────
  log-generator:
    build:
      context: .
      dockerfile: log-generator/Dockerfile
    container_name: splunk-demo-generator
    depends_on:
      splunk:
        condition: service_healthy
    environment:
      SPLUNK_HEC_URL: https://splunk:8088
      SPLUNK_HEC_TOKEN: ${SPLUNK_HEC_TOKEN:-demo-hec-token-12345}
      GENERATION_RATE: ${GENERATION_RATE:-medium}
      PERSONAS: devops,sre,support,management
      INJECT_ANOMALIES: "true"
    restart: unless-stopped
    networks:
      - demo-network
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  # ─────────────────────────────────────────────────────────────
  # SEED DATA LOADER (runs once on startup)
  # ─────────────────────────────────────────────────────────────
  seed-loader:
    build:
      context: .
      dockerfile: seed-data/Dockerfile
    container_name: splunk-demo-seeder
    depends_on:
      splunk:
        condition: service_healthy
    environment:
      SPLUNK_URL: https://splunk:8089
      SPLUNK_HEC_URL: https://splunk:8088
      SPLUNK_USERNAME: admin
      SPLUNK_PASSWORD: ${SPLUNK_PASSWORD:-DemoPass123!}
      SPLUNK_HEC_TOKEN: ${SPLUNK_HEC_TOKEN:-demo-hec-token-12345}
      SEED_DAYS: 7
      EVENT_COUNT: 1000000
    volumes:
      - ./seed-data/data:/data:ro
      - seed-status:/status
    networks:
      - demo-network
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  # ─────────────────────────────────────────────────────────────
  # WEBHOOK CATCHER (for alert demonstrations)
  # ─────────────────────────────────────────────────────────────
  webhook-catcher:
    image: tarampampam/webhook-tester:latest
    container_name: splunk-demo-webhooks
    restart: unless-stopped
    networks:
      - demo-network
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  # ─────────────────────────────────────────────────────────────
  # REVERSE PROXY
  # ─────────────────────────────────────────────────────────────
  nginx:
    image: nginx:alpine
    container_name: splunk-demo-nginx
    # Ports defined in docker-compose.dev.yml for local dev
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/demo.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/upstreams.include:/etc/nginx/conf.d/upstreams.include:ro
      - ./nginx/locations.include:/etc/nginx/conf.d/locations.include:ro
      - ./landing-page:/var/www/html:ro
      - nginx-logs:/var/log/nginx
    command: >
      sh -c "rm -f /var/log/nginx/access.log /var/log/nginx/error.log &&
             touch /var/log/nginx/access.log /var/log/nginx/error.log &&
             nginx -g 'daemon off;'"
    depends_on:
      - queue-manager
      - splunk
      - lgtm
    restart: unless-stopped
    networks:
      - demo-network
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ─────────────────────────────────────────────────────────────
  # QUEUE MANAGER
  # ─────────────────────────────────────────────────────────────
  queue-manager:
    build: ./queue-manager
    container_name: splunk-demo-queue
    environment:
      - REDIS_URL=redis://redis:6379
      - SESSION_TIMEOUT_MINUTES=${SESSION_TIMEOUT_MINUTES:-60}
      - MAX_QUEUE_SIZE=${MAX_QUEUE_SIZE:-10}
      - SPLUNK_URL=https://splunk:8089
      - SPLUNK_WEB_URL=http://splunk:8000
      - SPLUNK_USERNAME=admin
      - SPLUNK_PASSWORD=${SPLUNK_PASSWORD:-DemoPass123!}
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OTEL_SERVICE_NAME=splunk-demo-queue-manager
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://lgtm:4318
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=otlp
      - SESSION_SECRET=${SESSION_SECRET:-change-me-in-production}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./secrets:/secrets:ro
      - ./demo-container:/opt/demo-container:ro
      - ./scripts:/opt/scripts:ro
    depends_on:
      - redis
      - splunk
      - lgtm
    restart: unless-stopped
    networks:
      - demo-network
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ─────────────────────────────────────────────────────────────
  # SESSION STATE
  # ─────────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: splunk-demo-redis
    volumes:
      - redis-data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - demo-network
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  # ─────────────────────────────────────────────────────────────
  # OBSERVABILITY (LGTM Stack)
  # ─────────────────────────────────────────────────────────────
  lgtm:
    image: grafana/otel-lgtm:latest
    container_name: splunk-demo-lgtm
    environment:
      - GF_SERVER_ROOT_URL=http://localhost:8080/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      - GF_AUTH_ANONYMOUS_ENABLED=false
      - GF_AUTH_PROXY_ENABLED=true
      - GF_AUTH_PROXY_HEADER_NAME=X-WEBAUTH-USER
      - GF_AUTH_PROXY_HEADER_PROPERTY=username
      - GF_AUTH_PROXY_AUTO_SIGN_UP=true
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/var/lib/grafana/dashboards/demo-home.json
    volumes:
      - ./observability/grafana-dashboards.yaml:/otel-lgtm/grafana/conf/provisioning/dashboards/splunk-demo.yaml:ro
      - ./observability/dashboards:/var/lib/grafana/dashboards:ro
      - lgtm-data:/data
    restart: unless-stopped
    networks:
      - demo-network
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: splunk-demo-redis-exporter
    environment:
      - REDIS_ADDR=redis://redis:6379
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - demo-network
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  promtail:
    image: grafana/promtail:latest
    container_name: splunk-demo-promtail
    volumes:
      - ./observability/promtail-config.yaml:/etc/promtail/config.yml:ro
      - nginx-logs:/var/log/nginx:ro
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - lgtm
    restart: unless-stopped
    networks:
      - demo-network
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

networks:
  demo-network:
    name: splunk-demo-network
    driver: bridge

volumes:
  splunk-var:
  splunk-etc:
  redis-data:
  nginx-logs:
  lgtm-data:
  seed-status:
